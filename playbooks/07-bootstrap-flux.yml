---
- name: Bootstrap FluxCD
  hosts: cp_init
  become: true
  tags: [vault, flux]
  tasks:
    - name: Get GitHub token from Vault
      set_fact:
        github_token: "{{ lookup('community.hashi_vault.hashi_vault', 'secret/data/flux/github-token:token url=' ~ vault_addr ~ ' token=' ~ lookup('env', 'VAULT_TOKEN')) }}"
      no_log: true

    - name: Install which
      community.general.pacman:
        name: which
        state: present

    - name: Install Flux CLI
      shell: curl -s https://fluxcd.io/install.sh | bash
      args:
        creates: /usr/local/bin/flux

    - name: Check if flux-system namespace exists
      command: kubectl --kubeconfig /etc/kubernetes/admin.conf get namespace flux-system
      register: flux_ns
      failed_when: false
      changed_when: false

    - name: Bootstrap FluxCD
      command: >
        flux bootstrap github
        --owner=BenRachmiel
        --repository=flux-k8s-homelab
        --branch=main
        --path=clusters/homelab
        --personal
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
        GITHUB_TOKEN: "{{ github_token }}"
      when: flux_ns.rc != 0
