---
- name: Bootstrap FluxCD
  hosts: cp_init
  become: true
  tasks:
    - name: Get GitHub token from Vault
      set_fact:
        github_token: "{{ lookup('community.hashi_vault.hashi_vault', 'secret/data/flux/github-token:token url=' ~ vault_addr ~ ' token=' ~ lookup('env', 'VAULT_TOKEN')) }}"
      no_log: true

    - name: Install which
      community.general.pacman:
        name: which
        state: present

    - name: Install Flux CLI
      shell: curl -s https://fluxcd.io/install.sh | bash
      args:
        creates: /usr/local/bin/flux

    - name: Check if flux-system namespace exists
      command: kubectl --kubeconfig /etc/kubernetes/admin.conf get namespace flux-system
      register: flux_ns
      failed_when: false
      changed_when: false

    - name: Bootstrap FluxCD
      command: >
        flux bootstrap github
        --owner=BenRachmiel
        --repository=flux-k8s-homelab
        --branch=main
        --path=clusters/homelab
        --personal
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
        GITHUB_TOKEN: "{{ github_token }}"
      when: flux_ns.rc != 0

    - name: Wait for Gateway Service to exist
      command: >
        kubectl --kubeconfig /etc/kubernetes/admin.conf
        get svc cilium-gateway-homelab -n default
      register: gw_svc
      retries: 30
      delay: 10
      until: gw_svc.rc == 0
      changed_when: false

    - name: Pin Gateway NodePorts
      command: >
        kubectl --kubeconfig /etc/kubernetes/admin.conf
        patch svc cilium-gateway-homelab -n default --type=json
        -p='[{"op":"replace","path":"/spec/ports/0/nodePort","value":30080},{"op":"replace","path":"/spec/ports/1/nodePort","value":30443}]'
      changed_when: true
